local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")

-- Function to create and update the highlight for a player
local function highlightPlayer(player)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        -- Create a BillboardGui to display the player's name
        local billboard = Instance.new("BillboardGui")
        billboard.Size = UDim2.new(0, 100, 0, 50)  -- Adjust size as needed
        billboard.StudsOffset = Vector3.new(0, 3, 0)  -- Position above the player
        billboard.Parent = player.Character.HumanoidRootPart

        -- Create a TextLabel to show the player's name
        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.Text = player.Name
        textLabel.TextColor3 = Color3.new(1, 1, 1)  -- White text color
        textLabel.TextScaled = true
        textLabel.Parent = billboard

        -- Create a highlight effect
        local highlight = Instance.new("Highlight")
        highlight.Adornee = player.Character
        highlight.FillColor = Color3.new(1, 1, 0)  -- Yellow highlight
        highlight.Parent = player.Character

        -- Update the visibility of the BillboardGui based on visibility
        local function updateVisibility()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local playerPosition = player.Character.HumanoidRootPart.Position
                local localPlayerPosition = LocalPlayer.Character and LocalPlayer.Character.HumanoidRootPart.Position

                if localPlayerPosition then
                    -- Raycast to check for obstructions
                    local ray = Ray.new(localPlayerPosition, (playerPosition - localPlayerPosition).unit * (localPlayerPosition - playerPosition).magnitude)
                    local hitPart = workspace:FindPartOnRay(ray, LocalPlayer.Character)

                    -- Show or hide the BillboardGui based on visibility
                    billboard.Enabled = hitPart == nil or hitPart:IsDescendantOf(workspace)
                end
            end
        end

        -- Connect the update function to RenderStepped
        RunService.RenderStepped:Connect(updateVisibility)
    end
end

-- Function to find the closest player to the local player
local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge  -- Start with a very large distance

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local distance = (LocalPlayer.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).magnitude
            if distance < closestDistance then
                closestDistance = distance
                closestPlayer = player
            end
        end
    end

    return closestPlayer
end

-- Function to update highlights based on the closest player
local function updateHighlights()
    -- Remove existing highlights
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local highlight = player.Character:FindFirstChildOfClass("Highlight")
            if highlight then
                highlight:Destroy()
            end
        end
    end

    -- Highlight the closest player
    local closestPlayer = getClosestPlayer()
    if closestPlayer then
        highlightPlayer(closestPlayer)
    end
end

-- Connect the update function to RenderStepped
RunService.RenderStepped:Connect(updateHighlights)

-- Listen for players joining or leaving
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        updateHighlights()
    end)
end)

Players.PlayerRemoving:Connect(updateHighlights)
